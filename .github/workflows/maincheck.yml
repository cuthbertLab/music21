name: maincheck

on:
    push:
        branches:
        - master
        - '*CI*'
    pull_request:
        branches:
        - '*'

jobs:
    run_tests:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [3.11, 3.12, 3.13, 3.14]
        steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v4
          with:
              python-version: ${{ matrix.python-version }}
        - name: Install uv
          uses: astral-sh/setup-uv@v7
          with:
              enable-cache: true
              cache-dependency-glob: |
                  pyproject.toml
        - name: Install Ubuntu dependencies
          run: ./.github/scripts/install_ubuntu_deps.sh
        - name: Setup Lilypond
          run: python -c 'from music21 import environment; environment.UserSettings()["lilypondPath"] = "/home/runner/bin/lilypond"'
        - name: Run Main Test script
          run: python -c 'from music21.test.testSingleCoreAll import ciMain as ci; ci()'
        - name: Coveralls
          if: ${{ matrix.python-version == '3.12' }}
          env:  # when changing number above also change coverageM21.getCoverage
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              COVERALLS_SERVICE_NAME: github
          run: coveralls

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.14'
                  cache: 'pip'
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: |
                      pyproject.toml
            - name: Install dependencies
              run: |
                  uv pip install wheel
                  uv pip install -e '.[dev]'
            - name: Install music21 in editable mode
              run: |
                  uv pip install -e .
            - name: Lint with pylint
              run: |
                  uv run pylint -j0 music21
                  uv run pylint -j0 documentation

    ruff:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.14'
                  cache: 'pip'
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: |
                      pyproject.toml
            - name: Install dependencies
              run: |
                  uv pip install wheel
                  uv pip install -e '.[dev]'
            - name: Code-style etc. with Ruff
              run: |
                  uv run ruff check music21
                  uv run ruff check documentation

    mypy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.14'
                  cache: 'pip'
            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  cache-dependency-glob: |
                      pyproject.toml
            - name: Install dependencies
              run: |
                  uv pip install wheel
                  uv pip install -e '.[dev]'
            - name: Type-check all modules with mypy
              run: |
                  uv run mypy music21
